from string import punctuation
from nltk import RegexpTokenizer
from nltk.stem.porter import PorterStemmer
from nltk.corpus import stopwords
from sklearn.datasets import fetch_20newsgroups
from gensim.models import LdaModel
import matplotlib.pyplot as plt
import json


newsgroups = fetch_20newsgroups()
eng_stopwords = set(stopwords.words('english'))

tokenizer = RegexpTokenizer(r'\s+', gaps=True)
stemmer = PorterStemmer()
translate_tab = {ord(p): u" " for p in punctuation}

def text2tokens(raw_text):
    """Split the raw_text string into a list of stemmed tokens."""
    clean_text = raw_text.lower().translate(translate_tab)
    tokens = [token.strip() for token in tokenizer.tokenize(clean_text)]
    tokens = [token for token in tokens if token not in eng_stopwords]
    stemmed_tokens = [stemmer.stem(token) for token in tokens]
    return [token for token in stemmed_tokens if len(token) > 2]  # skip short tokens

#dataset = [text2tokens(txt) for txt in newsgroups['data']]  # convert a documents to list of tokens

from gensim.corpora import Dictionary
#Vanilla version creating the dictionary from input text
#dictionary = Dictionary(documents=dataset, prune_at=None)
#dictionary.filter_extremes(no_below=5, no_above=0.3, keep_n=None)  # use Dictionary to remove un-relevant tokens
#dictionary.compactify()

#Pick the same value used for the training of scholar
dictionaryFromScholar = [["_eos_", "write", "one", "use", "get", "say", "article", "know", "people", "make", "go", "like", "think", "see", "time", "also", "work", "take", "year", "new", "good", "want", "come", "thing", "even", "way", "well", "look", "give", "system", "may", "need", "problem", "find", "god", "file", "try", "many", "much", "first", "two", "right", "call", "run", "point", "question", "anyone", "tell", "post", "believe", "drive", "seem", "program", "something", "number", "please", "really", "since", "mean", "back", "include", "day", "still", "state", "help", "read", "government", "information", "start", "key", "law", "case", "game", "thanks", "last", "must", "part", "let", "better", "never", "might", "ask", "sure", "support", "another", "group", "car", "without", "name", "send", "keep", "fact", "lot", "man", "someone", "power", "line", "put", "set", "available", "follow", "window", "hear", "show", "university", "world", "team", "list", "little", "place", "change", "space", "however", "play", "reason", "anything", "happen", "around", "probably", "every", "course", "long", "life", "true", "consider", "computer", "card", "christian", "bit", "datum", "word", "best", "least", "end", "gun", "different", "claim", "buy", "talk", "opinion", "provide", "enough", "leave", "chip", "order", "idea", "book", "great", "note", "software", "example", "jesus", "version", "actually", "far", "issue", "possible", "though", "live", "either", "kill", "source", "base", "second", "person", "answer", "rather", "exist", "real", "nothing", "win", "image", "control", "cause", "john", "david", "email", "hard", "else", "allow", "old", "child", "next", "public", "wrong", "subject", "human", "maybe", "yes", "address", "turn", "able", "phone", "standard", "bad", "driver", "windows", "disk", "high", "always", "free", "internet", "machine", "require", "become", "hand", "kind", "less", "several", "build", "feel", "price", "player", "general", "report", "pay", "quite", "ever", "three", "today", "code", "cost", "sell", "hope", "yet", "away", "home", "result", "mail", "type", "area", "big", "sound", "create", "remember", "research", "week", "message", "check", "israel", "application", "move", "whether", "country", "center", "hold", "user", "understand", "current", "side", "already", "money", "speed", "open", "assume", "president", "agree", "bill", "mark", "evidence", "national", "value", "argument", "matter", "add", "war", "display", "design", "view", "force", "offer", "technology", "color", "mention", "science", "ago", "us", "stop", "info", "company", "perhaps", "box", "american", "local", "rule", "lead", "small", "bible", "large", "fax", "copy", "mac", "act", "love", "pretty", "rights", "server", "difference", "access", "memory", "encryption", "study", "whole", "guy", "care", "experience", "test", "interested", "return", "rate", "mind", "carry", "die", "deal", "appear", "package", "attack", "expect", "woman", "jews", "stuff", "bring", "head", "lose", "service", "job", "religion", "everything", "church", "friend", "contact", "april", "speak", "accept", "important", "save", "news", "member", "month", "city", "comment", "truth", "device", "death", "house", "hit", "pass", "turkish", "appreciate", "guess", "sort", "action", "often", "model", "pc", "original", "error", "everyone", "simply", "level", "form", "effect", "wonder", "close", "later", "reference", "fire", "light", "body", "steve", "bike", "full", "anyway", "although", "armenian", "almost", "suggest", "weapon", "certainly", "statement", "instead", "receive", "season", "break", "couple", "anybody", "explain", "cover", "history", "plan", "contain", "correct", "single", "db", "discussion", "output", "present", "begin", "board", "size", "involve", "unless", "position", "crime", "mode", "entry", "sense", "situation", "ftp", "decide", "israeli", "similar", "faith", "monitor", "dos", "certain", "function", "site", "press", "product", "format", "event", "release", "advance", "quote", "period", "reply", "drug", "major", "face", "individual", "likely", "suppose", "term", "figure", "net", "purpose", "within", "armenians", "black", "clear", "paul", "road", "white", "security", "continue", "goal", "video", "earth", "nice", "sun", "learn", "usually", "belief", "exactly", "except", "police", "hell", "mike", "private", "protect", "oh", "top", "especially", "hockey", "sale", "network", "christ", "install", "michael", "response", "section", "process", "apply", "date", "school", "watch", "hardware", "wait", "per", "sorry", "stand", "newsgroup", "dod", "attempt", "policy", "simple", "via", "fast", "mine", "record", "request", "ground", "screen", "thus", "fine", "common", "increase", "million", "pick", "fan", "fail", "concern", "tax", "prove", "business", "jim", "project", "produce", "regard", "arm", "fall", "jewish", "launch", "among", "low", "league", "widget", "rest", "apple", "office", "clipper", "night", "particular", "choose", "interest", "bus", "cut", "organization", "dead", "describe", "text", "condition", "story", "society", "develop", "easy", "ca", "detail", "land", "therefore", "score", "clinton", "page", "ride", "interesting", "court", "canada", "command", "chance", "bear", "food", "option", "third", "accord", "ok", "port", "whatever", "short", "strong", "past", "health", "department", "moral", "spend", "division", "due", "graphic", "radio", "faq", "miss", "limit", "atheist", "future", "compare", "author", "directory", "manager", "hus", "longer", "military", "method", "anonymous", "theory", "early", "robert", "four", "red", "unit", "draw", "refer", "sometimes", "total", "personal", "criminal", "front", "tape", "authority", "engine", "nasa", "notice", "object", "upon", "field", "occur", "special", "voice", "forget", "recently", "san", "water", "soon", "york", "algorithm", "controller", "define", "young", "behind", "delete", "usa", "family", "switch", "interface", "along", "wish", "worth", "tool", "lie", "together", "united", "citizen", "agency", "amount", "complete", "religious", "party", "doubt", "feature", "scsi", "discuss", "library", "mouse", "official", "replace", "approach", "avoid", "judge", "previous", "federal", "class", "murder", "father", "necessary", "trade", "administration", "bob", "ram", "dave", "knowledge", "prevent", "james", "throw", "washington", "legal", "various", "currently", "final", "la", "peace", "series", "handle", "sign", "solution", "choice", "otherwise", "privacy", "near", "specific", "basis", "serve", "meet", "political", "fix", "block", "minute", "letter", "sin", "market", "average", "font", "states", "firearm", "picture", "population", "clearly", "effort", "manual", "outside", "realize", "remain", "resource", "depend", "determine", "hour", "language", "quality", "shall", "plus", "stay", "title", "account", "input", "remove", "performance", "document", "station", "charge", "serious", "son", "main", "objective", "publish", "defense", "medical", "freedom", "motif", "practice", "secret", "cable", "international", "baseball", "doctor", "ibm", "development", "higher", "respond", "willing", "convert", "search", "thank", "tv", "street", "completely", "fbi", "purchase", "wire", "lack", "activity", "flame", "vote", "connect", "count", "gas", "unix", "inside", "drop", "half", "share", "shot", "disease", "fit", "owner", "argue", "brian", "air", "fight", "existence", "kid", "printer", "systems", "technical", "nature", "turkey", "apr", "eye", "safety", "christianity", "ii", "load", "none", "secure", "supply", "basic", "building", "insurance", "bank", "peter", "disclaimer", "media", "modem", "normal", "serial", "smith", "age", "community", "decision", "satellite", "stephanopoulos", "obtain", "print", "student", "america", "communication", "greek", "indeed", "russian", "al", "institute", "operation", "transfer", "beat", "finally", "range", "reach", "trust", "reduce", "armenia", "etc", "suggestion", "keyboard", "toronto", "room", "thousand", "commercial", "congress", "easily", "grant", "material", "useful", "chicago", "door", "mile", "turks", "reasonable", "arab", "direct", "obviously", "folk", "sit", "digital", "directly", "stick", "fund", "scientific", "dealer", "pull", "raise", "addition", "faster", "generally", "tom", "difficult", "pt", "definition", "express", "internal", "ide", "nhl", "unfortunately", "character", "orbit", "store", "worse", "eat", "frank", "imagine", "mb", "paper", "obvious", "stupid", "conclusion", "enforcement", "entire", "floppy", "intend", "measure", "ed", "wife", "commit", "engineering", "shoot", "somebody", "excellent", "listen", "mission", "byte", "apparently", "magazine", "blood", "lord", "step", "tend", "vehicle", "appropriate", "ability", "archive", "item", "lower", "upgrade", "evil", "suspect", "trial", "whose", "de", "king", "recent", "btw", "happy", "maintain", "pittsburgh", "round", "risk", "teach", "conference", "germany", "alone", "amendment", "hole", "neither", "perform", "south", "vs", "circuit", "client", "mass", "north", "richard", "environment", "george", "signal", "treat", "trouble", "context", "gm", "recognize", "escrow", "late", "patient", "scott", "thought", "west", "extra", "foot", "burn", "nation", "admit", "california", "natural", "indicate", "mother", "propose", "slow", "suffer", "five", "village", "generate", "soldier", "thomas", "walk", "march", "absolute", "electronic", "keith", "pin", "ten", "western", "east", "nsa", "across", "enter", "select", "leader", "left", "possibly", "cd", "heart", "respect", "review", "dog", "prefer", "recommend", "yeah", "chris", "deny", "establish", "msg", "texas", "blow", "des", "master", "moon", "morality", "universe", "usenet", "volume", "basically", "pain", "push", "reality", "recall", "analysis", "cup", "muslim", "somewhere", "ad", "means", "poor", "civilian", "connection", "ignore", "ma", "perfect", "catch", "education", "hp", "property", "regular", "responsible", "andrew", "boston", "eric", "simm", "constitution", "majority", "oil", "van", "civil", "effective", "industry", "link", "meaning", "fear", "former", "physical", "separate", "tank", "army", "beyond", "false", "proposal", "animal", "hundred", "koresh", "modern", "piece", "thread", "americans", "ny", "advice", "benefit", "destroy", "fairly", "multiple", "table", "cheap", "hey", "seriously", "agent", "imply", "militia", "necessarily", "playoff", "heaven", "parent", "equipment", "officer", "rocket", "tim", "dan", "penalty", "clock", "treatment", "nobody", "particularly", "race", "blue", "earlier", "matthew", "protection", "sex", "escape", "expensive", "gif", "hot", "middle", "surface", "concept", "handgun", "jpeg", "personally", "ship", "distribution", "safe", "waste", "logic", "holy", "illegal", "manage", "meg", "topic", "jon", "doug", "host", "mistake", "announce", "committee", "flight", "los", "loss", "steal", "associate", "straight", "bother", "demand", "guarantee", "star", "town", "greatly", "improve", "innocent", "social", "advantage", "brain", "degree", "description", "forward", "homosexual", "minor", "scripture", "surprise", "latest", "lock", "spirit", "cross", "gain", "joe", "nuclear", "traffic", "ball", "cop", "dangerous", "hate", "possibility", "related", "six", "soul", "factor", "responsibility", "vancouver", "college", "german", "highly", "independent", "islam", "neighbor", "represent", "alternative", "billion", "hello", "license", "os", "century", "ron", "shell", "sport", "update", "impossible", "interpretation", "proof", "club", "minority", "moment", "pressure", "repeat", "vga", "wide", "edge", "pat", "poster", "genocide", "jack", "proper", "specifically", "gary", "grow", "mostly", "pitch", "seek", "weight", "witness", "entirely", "int", "justice", "mailing", "manufacturer", "motherboard", "nt", "oppose", "valid", "instance", "structure", "absolutely", "andor", "dollar", "engineer", "europe", "everybody", "string", "technique", "actual", "art", "besides", "bunch", "conflict", "draft", "reader", "scientist", "shipping", "quick", "roger", "totally", "worry", "expert", "fly", "resolution", "tie", "aid", "fair", "ie", "implement", "motorcycle", "soviet", "telephone", "utility", "brother", "double", "eternal", "shuttle", "border", "guide", "hurt", "requirement", "routine", "tire", "damage", "plug", "significant", "additional", "aware", "lab", "morning", "sunday", "wall", "capability", "default", "graphics", "instruction", "luck", "sample", "blame", "lunar", "operate", "plane", "posting", "atheism", "finish", "mhz", "popular", "angeles", "background", "battery", "desire", "jet", "pgp", "programming", "rob", "screw", "specify", "stream", "abuse", "channel", "disagree", "easier", "fill", "role", "bug", "defend", "map", "merely", "uucp", "wear", "affect", "remark", "status", "target", "understanding", "convince", "detroit", "jeff", "medicine", "okay", "slot", "behavior", "compile", "direction", "fully", "greater", "sexual", "summer", "uk", "xterm", "potential", "russia", "cpu", "export", "management", "principle", "rock", "training", "british", "excuse", "gay", "reading", "register", "join", "ken", "na", "scheme", "typical", "boot", "european", "green", "towards", "compound", "dc", "mountain", "corporation", "facility", "properly", "quickly", "summary", "ban", "energy", "promise", "remote", "welcome", "enjoy", "hd", "ice", "id", "muslims", "park", "radar", "solve", "brake", "cache", "discover", "distribute", "external", "frame", "islamic", "lay", "reject", "attitude", "crypto", "hang", "heavy", "ready", "tear", "alive", "assumption", "boy", "button", "deserve", "domain", "exact", "fault", "gordon", "isa", "translation", "xt", "economic", "hall", "larger", "panel", "stephen", "accident", "budget", "char", "creation", "fun", "joseph", "male", "meeting", "montreal", "random", "rom", "spec", "tel", "batf", "catholic", "nazi", "path", "conversation", "equal", "immediately", "massacre", "postscript", "attention", "buf", "georgia", "leafs", "refuse", "track", "visual", "worship", "bmw", "brand", "cold", "comparison", "editor", "movement", "permit", "relate", "reveal", "somewhat", "wave", "definitely", "feeling", "rangers", "warrant", "compatible", "drink", "english", "eventually", "hospital", "jose", "probe", "ray", "sequence", "somehow", "yesterday", "anywhere", "jew", "location", "pp", "sick", "spot", "threat", "ticket", "toward", "aspect", "audio", "injury", "setting", "cal", "jason", "match", "philadelphia", "solid", "strike", "apartment", "database", "element", "hide", "mary", "neutral", "ahead", "experiment", "huge", "larry", "microsoft", "patch", "pm", "rise", "terrorist", "zone", "bar", "foreign", "identify", "rider", "limited", "mit", "normally", "observation", "percent", "slightly", "troops", "capable", "despite", "documentation", "feed", "fuel", "nearly", "passage", "processing", "clean", "crash", "demonstrate", "dream", "employer", "mechanism", "opportunity", "positive", "reaction", "slave", "component", "finger", "greg", "lee", "victim", "assault", "older", "self", "session", "stage", "visit", "arabs", "australia", "cheaper", "contract", "compromise", "debate", "intelligence", "modify", "nec", "processor", "scale", "schedule", "seat", "secretary", "style", "bbs", "bottom", "conduct", "gmt", "interpret", "legitimate", "louis", "root", "setup", "teaching", "winner", "app", "belong", "bias", "jump", "kevin", "laugh", "relationship", "truly", "automatic", "bet", "contest", "cryptography", "implementation", "japanese", "jumper", "marriage", "pro", "speech", "success", "afraid", "azerbaijan", "damn", "island", "organize", "seattle", "connector", "correctly", "fool", "foundation", "length", "ted", "alan", "association", "culture", "doctrine", "explanation", "generation", "newspaper", "re", "ac", "charles", "credit", "failure", "fred", "journal", "lebanese", "nj", "onto", "territory", "usual", "william", "complex", "detector", "electrical", "helmet", "june", "menu", "prepare", "tony", "wheel", "mr", "sentence", "surely", "terminal", "twice", "auto", "binary", "cancer", "cycle", "data", "pray", "professional", "rich", "swap", "tradition", "warning", "bb", "encrypt", "favor", "marc", "planet", "proceed", "punishment", "scsus", "services", "accurate", "brad", "bush", "coverage", "craig", "frequently", "heat", "null", "phil", "resistance", "ryan", "colorado", "complain", "et", "expansion", "impact", "mount", "plant", "pop", "shift", "sufficient", "wiretap", "backup", "bay", "cool", "floor", "following", "installation", "joke", "lebanon", "times", "canadian", "curious", "decent", "liberty", "mon", "noise", "outlet", "parallel", "physics", "procedure", "stats", "truck", "collection", "electronics", "printf", "relevant", "rsa", "shape", "worst", "amp", "encourage", "historical", "papers", "region", "relative", "verse", "cambridge", "computing", "confuse", "ensure", "equivalent", "fee", "gateway", "platform", "wing", "bell", "configuration", "essentially", "francisco", "max", "solar", "speaker", "stone", "toolkit", "bio", "edition", "kent", "palestinian", "spacecraft", "weak", "band", "coach", "imho", "professor", "sea", "sleep", "stanley", "motor", "pixel", "protocol", "spring", "adapter", "andy", "biblical", "cap", "collect", "extremely", "hardly", "prior", "reasoning", "ripem", "senate", "strip", "trip", "vary", "career", "deep", "director", "hint", "hitler", "prohibit", "relation", "sector", "submit", "acquire", "bruce", "challenge", "cite", "distance", "extension", "patrick", "pope", "smaller", "active", "braves", "buffer", "expose", "insist", "regardless", "reserve", "statistics", "task", "wiring", "chapter", "consideration", "converter", "justify", "laboratory", "minnesota", "motorola", "powerful", "touch", "dec", "echo", "honda", "logical", "music", "perfectly", "quadra", "rely", "violation", "waco", "xlib", "cell", "compression", "conclude", "economy", "frequency", "plain", "relatively", "restriction", "variety", "vendor", "visible", "achieve", "anymore", "arrive", "beginning", "contribute", "corner", "duty", "movie", "myers", "participate", "pit", "prediction", "puck", "revelation", "signature", "virtual", "acceptable", "baby", "content", "cult", "defensive", "det", "detect", "focus", "homicide", "living", "mov", "oo", "reflect", "render", "adams", "bomb", "danger", "exercise", "macintosh", "observe", "rear", "thinking", "estimate", "guilty", "index", "liberal", "overall", "pair", "shop", "branch", "calgary", "central", "execute", "flyers", "funny", "hence", "min", "ottawa", "pattern", "transmission", "tube", "turbo", "voltage", "adam", "aside", "battle", "colormap", "daniel", "examine", "filter", "ignorance", "johnson", "manner", "mirror", "origin", "primary", "programmer", "regulation", "ring", "spread", "survive", "train", "travel", "warn", "workstation", "brown", "camera", "careful", "exchange", "girl", "oname", "pitcher", "reliable", "surrender", "variable", "allen", "annual", "cipher", "closer", "copyright", "crack", "daughter", "gear", "greece", "initial", "kit", "knife", "miller", "mix", "module", "originally", "plot", "prophecy", "representative", "attach", "consistent", "french", "que", "shut", "sky", "staff", "unlikely", "winnipeg", "daily", "exit", "harm", "inch", "md", "offense", "prayer", "resurrection", "strange", "violent", "wings", "atlanta", "award", "category", "customer", "douglas", "expand", "extend", "gang", "houston", "iii", "libertarian", "pen", "prophet", "satan", "saturn", "seconds", "eliminate", "exception", "february", "investigation", "marry", "mask", "violate", "writer", "capital", "contrary", "council", "familiar", "ford", "lewis", "manufacture", "mouth", "paint", "predict", "previously", "rape", "remind", "roll", "senior", "southern", "strongly", "supposedly", "symptom", "amiga", "bh", "biggest", "helpful", "highest", "hitter", "tor", "ps", "pd", "io", "cs", "ab", "tm", "st", "hr", "sp", "mi", "ah", "km", "rg", "mg", "rf", "eus", "mw", "pl", "ax", "sl", "wm", "bhj"]]

#Taking the value from Scholar training set
f = open('train.tokens.json')
data = json.load(f)
data = [line.split(' ') for line in data]

dictionary = Dictionary(documents=dictionaryFromScholar, prune_at=None)
dictionary.compactify()


d2b_dataset = [dictionary.doc2bow(doc) for doc in data]



num_topics = 50
lda_model = LdaModel(
    corpus=d2b_dataset, num_topics=num_topics, per_word_topics=True)

topics = lda_model.print_topics(50, 100)
elements = []

for i in range(len(topics)):
    toAppend = topics[i][1].split('+')
    toAppend = [dictionary[int(line.split('*"')[1][:-2])] for line in toAppend]
    elements.append(toAppend)


print('End')
def plot_difference_plotly(mdiff, title="", annotation=None):
    """Plot the difference between models.

    Uses plotly as the backend."""
    import plotly.graph_objs as go
    import plotly.offline as py

    annotation_html = None
    if annotation is not None:
        annotation_html = [
            [
                "+++ {}<br>--- {}".format(", ".join(int_tokens), ", ".join(diff_tokens))
                for (int_tokens, diff_tokens) in row
            ]
            for row in annotation
        ]

    data = go.Heatmap(z=mdiff, colorscale='RdBu', text=annotation_html)
    layout = go.Layout(width=950, height=950, title=title, xaxis=dict(title="topic"), yaxis=dict(title="topic"))
    py.iplot(dict(data=[data], layout=layout))


def plot_difference_matplotlib(mdiff, title="", annotation=None):
    """Helper function to plot difference between models.

    Uses matplotlib as the backend."""

    fig, ax = plt.subplots(figsize=(18, 14))
    data = ax.imshow(mdiff, cmap='RdBu_r', origin='lower')
    plt.title(title)
    plt.colorbar(data)


try:

    import plotly.offline as py
except Exception:
    #
    # Fall back to matplotlib if we're not in a notebook, or if plotly is
    # unavailable for whatever reason.
    #
    plot_difference = plot_difference_matplotlib
else:
    try:
        py.init_notebook_mode()
        plot_difference = plot_difference_plotly
    except:
        print('Oh cazz')

print('endOfProgram')
input()
